<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extrator de Códigos de Planilhas</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS (XLSX) CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-5xl mx-auto p-6">

    <!-- HEADER com logo inline (sempre carrega) -->
    <header class="mb-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">Extrator de Códigos de Planilhas</h1>
          <p class="text-sm md:text-base text-slate-600 mt-1">
            Carregue várias planilhas (.xlsx, .xls, .csv). O app lê todas as abas e extrai códigos usando um padrão (regex)
            configurável. Funciona 100% no navegador — ideal para GitHub Pages.
          </p>
        </div>
        <!-- “logo Correios” genérico (SVG inline) -->
        <svg class="h-12 w-auto opacity-90 select-none" viewBox="0 0 180 40" aria-label="Correios">
          <rect x="0" y="0" width="180" height="40" rx="6" fill="#005BBB"></rect>
          <polygon points="12,20 28,6 28,20 12,34" fill="#FFD500"></polygon>
          <text x="40" y="26" font-family="Arial, Helvetica, sans-serif" font-size="18" fill="white">Correios</text>
        </svg>
      </div>
    </header>

    <!-- CONFIGURAÇÕES (extrator) -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-3">Padrão de extração</h2>
        <label class="block text-sm mb-1">Preset</label>
        <select id="preset" class="w-full border rounded-lg p-2">
          <option value="sro">SRO (AA123456789BR)</option>
          <option value="digits">Somente números (8–13 dígitos)</option>
          <option value="alnum">Alfanumérico (10+ caracteres seguidos)</option>
          <option value="custom">Customizar (regex)</option>
        </select>
        <label class="block text-sm mt-3 mb-1">Regex</label>
        <input id="regexInput" class="w-full border rounded-lg p-2 font-mono" value="\\b[A-Z]{2}\\d{9}[A-Z]{2}\\b" />
        <p class="text-xs text-slate-500 mt-1">
          Dica: use <code class="font-mono">\\b</code> para borda de palavra. O padrão acima captura objetos SRO (ex.: <span class="font-mono">LB123456789BR</span>).
        </p>
        <div class="flex items-center gap-3 mt-4">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="caseFold" type="checkbox" class="rounded" checked /> Normalizar maiúsculas
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="dedupe" type="checkbox" class="rounded" checked /> Remover duplicados
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="trimSpaces" type="checkbox" class="rounded" checked /> Aparar espaços
          </label>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-3">Arquivos</h2>
        <label class="block text-sm mb-1">Selecione planilhas (.xlsx, .xls, .csv)</label>
        <input id="fileInput" type="file" multiple accept=".xlsx,.xls,.csv" class="w-full border rounded-lg p-2" />
        <div id="dropzone" class="mt-3 border-2 border-dashed rounded-xl p-6 text-center text-slate-500">Arraste e solte arquivos aqui</div>
        <button id="btnProcess" class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Processar arquivos</button>
        <p id="status" class="text-sm text-slate-600 mt-2"></p>
      </div>
    </section>

    <!-- RESULTADOS -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="font-semibold mb-3">Resultados</h2>
      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnCopy" class="px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg disabled:opacity-40" disabled>Copiar códigos</button>
        <button id="btnExportCSV" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar CSV</button>
        <button id="btnExportXLSX" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar XLSX</button>
        <button id="btnClear" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg">Limpar</button>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <h3 class="font-medium mb-2">Códigos extraídos (<span id="count">0</span>)</h3>
          <textarea id="output" class="w-full h-64 border rounded-lg p-2 font-mono text-sm" placeholder="— vazio —"></textarea>
        </div>
        <div>
          <h3 class="font-medium mb-2">Arquivos lidos & stats</h3>
          <pre id="log" class="w-full h-64 border rounded-lg p-3 bg-slate-50 overflow-auto text-xs"></pre>
        </div>
      </div>
    </section>

    <!-- SRO interno: gerador de links -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="font-semibold mb-3">SRO interno — Gerar links rápidos</h2>
      <p class="text-sm text-slate-600 mb-3">
        Cole os códigos e gere links para o rastreamento <em>interno</em>. Funciona apenas na rede dos Correios.
      </p>
      <div class="grid md:grid-cols-3 gap-3 mb-3">
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Base URL do SRO interno</label>
          <input id="sroBaseUrl" class="w-full border rounded-lg p-2 font-mono" value="https://srointranet.correios.com.br/rastreamento?obj=" />
          <p class="text-xs text-slate-500 mt-1">
            Ex.: <span class="font-mono">https://srointranet.correios.com.br/rastreamento?obj=</span>
          </p>
        </div>
        <div class="md:col-span-1 flex items-end">
          <button id="btnSaveSRO" class="w-full px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg">Salvar base</button>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Cole os códigos (um por linha)</label>
          <textarea id="sroCodes" class="w-full h-40 border rounded-lg p-2 font-mono text-sm" placeholder="LB123456789BR
XX987654321BR
..."></textarea>
          <div class="mt-3 flex gap-2">
            <button id="btnGenLinks" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Gerar links</button>
            <button id="btnOpenAll" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-40" disabled>Abrir todos (com intervalo)</button>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Links gerados</label>
          <ul id="sroList" class="border rounded-lg p-3 h-40 overflow-auto text-sm"></ul>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-3">“Abrir todos” usa intervalo para evitar bloqueios do navegador.</p>
    </section>

    <!-- Rastreamento automático (intranet) – sem "Minhas Unidades" -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="font-semibold mb-3">Rastreamento automático — Intranet (opcional)</h2>
      <p class="text-sm text-slate-600 mb-3">Depende de um <strong>proxy</strong> interno. Se não tiver, use o módulo “Rastreamento por CSV (sem TI)” abaixo.</p>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="useExtracted" type="checkbox" class="rounded" checked /> Usar códigos extraídos
          </label>
          <label class="block text-sm mt-3">Ou cole os códigos (um por linha)</label>
          <textarea id="codesManual" class="w-full h-24 border rounded-lg p-2 font-mono text-sm" placeholder="LB123456789BR
XX987654321BR"></textarea>
        </div>
        <div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="chkSedex2" type="checkbox" class="rounded" checked /> Somente SEDEX
          </label>
          <label class="block text-sm mt-3">UF de postagem</label>
          <input id="ufPostagem2" class="w-full border rounded-lg p-2" value="RN" />
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnConsultarAuto" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Consultar status (intranet)</button>
        <button id="btnExportAutoCSV" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar CSV</button>
        <button id="btnExportAutoXLSX" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar XLSX</button>
        <span id="autoStatus" class="text-sm text-slate-600"></span>
      </div>

      <div class="overflow-auto border rounded-xl">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">Código</th>
              <th class="text-left p-2">Prazo máximo</th>
              <th class="text-left p-2">Em trânsito para</th>
            </tr>
          </thead>
          <tbody id="autoTable"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">Este recurso chama <code>/api/rastrear</code> em um servidor interno. Sem esse proxy, a consulta automática não funciona.</p>
    </section>

    <!-- RASTREAMENTO POR CSV (SEM TI) -->
    <section class="bg-white rounded-2xl shadow p-4 mb-6">
      <h2 class="font-semibold mb-3">Rastreamento por CSV (sem TI)</h2>
      <p class="text-sm text-slate-600 mb-3">
        Carregue o <strong>CSV/XLSX</strong> exportado do rastreamento interno. O app filtra
        <strong>SEDEX com postagem no RN</strong>, mostra o relatório e gera o e-mail pronto.
      </p>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div class="md:col-span-1">
          <label class="block text-sm mb-1">Arquivo (CSV/XLSX)</label>
          <input id="csvFile" type="file" accept=".csv,.xlsx,.xls" class="w-full border rounded-lg p-2" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Ou cole os dados CSV</label>
          <textarea id="csvPaste" class="w-full h-24 border rounded-lg p-2 font-mono text-sm" placeholder="codigo,servico,uf_postagem,prazo_maximo,em_transito_para
LB123...,SEDEX,RN,2025-10-28,CDD MOSSORO"></textarea>
        </div>
      </div>

      <details class="mb-4">
        <summary class="cursor-pointer text-sm text-slate-700">Mapeamento de colunas (ajuste se os nomes forem diferentes)</summary>
        <div class="grid md:grid-cols-5 gap-3 mt-3">
          <div><label class="block text-xs">Código</label><input id="mCodigo" class="w-full border rounded-lg p-2 text-sm" value="codigo" /></div>
          <div><label class="block text-xs">Serviço</label><input id="mServico" class="w-full border rounded-lg p-2 text-sm" value="servico" /></div>
          <div><label class="block text-xs">UF Postagem</label><input id="mUF" class="w-full border rounded-lg p-2 text-sm" value="uf_postagem" /></div>
          <div><label class="block text-xs">Prazo máximo</label><input id="mPrazo" class="w-full border rounded-lg p-2 text-sm" value="prazo_maximo" /></div>
          <div><label class="block text-xs">Em trânsito para</label><input id="mTransito" class="w-full border rounded-lg p-2 text-sm" value="em_transito_para" /></div>
        </div>
      </details>

      <div class="grid md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="csvOnlySedex" type="checkbox" class="rounded" checked /> Somente SEDEX
          </label>
        </div>
        <div>
          <label class="block text-sm">UF de postagem</label>
          <input id="csvUF" class="w-full border rounded-lg p-2" value="RN" />
        </div>
      </div>

      <div class="flex flex-wrap gap-2 mb-3">
        <button id="btnCsvProcess" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Gerar relatório</button>
        <button id="btnCsvExportX" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar XLSX</button>
        <button id="btnCsvExport"  class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg disabled:opacity-40" disabled>Exportar CSV</button>
        <button id="btnEmail"       class="px-3 py-2 bg-slate-800 hover:bg-slate-900 text-white rounded-lg disabled:opacity-40" disabled>Gerar e-mail</button>
        <button id="btnCopyEmail"   class="px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg disabled:opacity-40" disabled>Copiar e-mail</button>
        <button id="btnCopySubject" class="px-3 py-2 bg-slate-400 hover:bg-slate-500 text-white rounded-lg disabled:opacity-40" disabled>Copiar assunto</button>
      </div>

      <div id="emailPreviewWrap" class="hidden">
        <h3 class="font-medium mb-2">Prévia do e-mail</h3>
        <div class="border rounded-xl p-3 bg-slate-50 text-sm" id="emailPreview"></div>
      </div>

      <div class="overflow-auto border rounded-xl mt-4">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="text-left p-2">Código</th>
              <th class="text-left p-2">Prazo máximo</th>
              <th class="text-left p-2">Em trânsito para</th>
            </tr>
          </thead>
          <tbody id="csvTable"></tbody>
        </table>
      </div>
    </section>

    <!-- RODAPÉ -->
    <footer class="text-xs text-slate-500">
      <p>⚠️ Tudo roda localmente no seu navegador. Nenhum dado é enviado a servidores.</p>
      <div class="mt-2 flex items-center gap-2">
        <svg class="h-5 w-auto opacity-90" viewBox="0 0 180 40" aria-label="Correios">
          <rect x="0" y="0" width="180" height="40" rx="6" fill="#005BBB"></rect>
          <polygon points="12,20 28,6 28,20 12,34" fill="#FFD500"></polygon>
          <text x="40" y="26" font-family="Arial, Helvetica, sans-serif" font-size="18" fill="white">Correios</text>
        </svg>
        <span>
          Desenvolvido por <strong>Daniel Hugo Costa de Oliveira</strong> — <strong>Coordenador/UO</strong> — <strong>GERAE-RN</strong>
        </span>
      </div>
    </footer>
  </div>

  <script>
    // ----------------- UTILIDADES -----------------
    function makeRegex(preset, custom) {
      switch (preset) {
        case 'sro':    return /\b[A-Z]{2}\d{9}[A-Z]{2}\b/g; // LB123456789BR
        case 'digits': return /\b\d{8,13}\b/g;
        case 'alnum':  return /\b[A-Z0-9]{10,}\b/gi;
        case 'custom':
        default:
          try { return new RegExp(custom, 'gi'); } catch { return /$a/; }
      }
    }
    function toCSV(rows) { return rows.map(r => '"' + String(r).replace(/"/g, '""') + '"').join('\n'); }
    function download(filename, content, mime = 'text/plain;charset=utf-8') {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function exportXLSX(codes) {
      const ws = XLSX.utils.aoa_to_sheet([["codigo"], ...codes.map(c => [c])]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'codigos');
      const out = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'codigos.xlsx'; a.click();
      URL.revokeObjectURL(url);
    }
    function todayISO(){
      const d = new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function todayBR(){
      const d = new Date(), da=String(d.getDate()).padStart(2,'0'), m=String(d.getMonth()+1).padStart(2,'0'), y=d.getFullYear();
      return `${da}/${m}/${y}`;
    }

    // ----------------- ESTADO (Extrator) -----------------
    let collected = [];

    // ----------------- ELEMENTOS -----------------
    const presetEl = document.getElementById('preset');
    const regexEl = document.getElementById('regexInput');
    const caseFoldEl = document.getElementById('caseFold');
    const dedupeEl = document.getElementById('dedupe');
    const trimEl = document.getElementById('trimSpaces');

    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const btnProcess = document.getElementById('btnProcess');

    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const countEl = document.getElementById('count');
    const logEl = document.getElementById('log');

    const btnCopy = document.getElementById('btnCopy');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnExportXLSX = document.getElementById('btnExportXLSX');
    const btnClear = document.getElementById('btnClear');

    function enableActions(enable) {
      [btnCopy, btnExportCSV, btnExportXLSX].forEach(b => b.disabled = !enable);
    }
    function updateUI() {
      outputEl.value = collected.join('\n');
      countEl.textContent = String(collected.length);
      enableActions(collected.length > 0);
    }

    // Presets atualizam regex
    presetEl.addEventListener('change', () => {
      if (presetEl.value === 'sro')    regexEl.value = "\\b[A-Z]{2}\\d{9}[A-Z]{2}\\b";
      if (presetEl.value === 'digits') regexEl.value = "\\b\\d{8,13}\\b";
      if (presetEl.value === 'alnum')  regexEl.value = "\\b[A-Z0-9]{10,}\\b";
    });

    // Dropzone
    ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('border-blue-500','bg-blue-50'); }));
    ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('border-blue-500','bg-blue-50'); }));
    dropzone.addEventListener('drop', e => {
      const files = Array.from(e.dataTransfer.files || []);
      const dt = new DataTransfer(); files.forEach(f => dt.items.add(f));
      fileInput.files = dt.files;
      statusEl.textContent = `${files.length} arquivo(s) pronto(s).`;
    });

    // Processamento (Extrator)
    async function processFiles(files) {
      collected = []; updateUI(); logEl.textContent = '';
      const rx = makeRegex(presetEl.value, regexEl.value);
      const buffers = [];
      for (const f of files) buffers.push({ name: f.name, buf: await f.arrayBuffer() });

      let totalMatches = 0;
      for (const { name, buf } of buffers) {
        try {
          const wb = XLSX.read(buf, { type: 'array' });
          let fileMatches = 0;
          for (const sheetName of wb.SheetNames) {
            const ws = wb.Sheets[sheetName];
            const csv = XLSX.utils.sheet_to_csv(ws, { FS: ',', RS: '\n' });
            const text = caseFoldEl.checked ? csv.toUpperCase() : csv;
            const matches = text.match(rx) || [];
            matches.forEach(m => collected.push(trimEl.checked ? m.trim() : m));
            fileMatches += matches.length;
          }
          totalMatches += fileMatches;
          logEl.textContent += `✔ ${name}: ${fileMatches} código(s)\n`;
        } catch {
          // tentar como CSV puro
          try {
            const txt = new TextDecoder().decode(buf);
            const text = caseFoldEl.checked ? txt.toUpperCase() : txt;
            const matches = text.match(rx) || [];
            matches.forEach(m => collected.push(trimEl.checked ? m.trim() : m));
            totalMatches += matches.length;
            logEl.textContent += `✔ ${name} (CSV): ${matches.length} código(s)\n`;
          } catch {
            logEl.textContent += `✖ ${name}: erro ao ler arquivo.\n`;
          }
        }
      }

      if (dedupeEl.checked) {
        const seen = new Set(); collected = collected.filter(c => (seen.has(c) ? false : (seen.add(c), true)));
      }
      updateUI();
      statusEl.textContent = `Concluído. ${files.length} arquivo(s), ${totalMatches} ocorrência(s), ${collected.length} único(s).`;
    }
    btnProcess.addEventListener('click', () => {
      const files = Array.from(fileInput.files || []);
      if (!files.length) { statusEl.textContent = 'Selecione ao menos um arquivo.'; return; }
      statusEl.textContent = 'Lendo arquivos…'; processFiles(files);
    });

    // Ações extrator
    btnCopy.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(outputEl.value); statusEl.textContent = 'Códigos copiados.'; }
      catch { statusEl.textContent = 'Não foi possível copiar (permita acesso ao clipboard).'; }
    });
    btnExportCSV.addEventListener('click', () => download('codigos.csv', toCSV(collected), 'text/csv;charset=utf-8'));
    btnExportXLSX.addEventListener('click', () => exportXLSX(collected));
    btnClear.addEventListener('click', () => { collected = []; updateUI(); statusEl.textContent = 'Limpo.'; logEl.textContent = ''; fileInput.value = ''; });

    // ===== SRO interno: lógica dos links =====
    const sroBaseUrlInput = document.getElementById('sroBaseUrl');
    const sroCodesInput = document.getElementById('sroCodes');
    const sroList = document.getElementById('sroList');
    const btnGenLinks = document.getElementById('btnGenLinks');
    const btnOpenAll = document.getElementById('btnOpenAll');
    const btnSaveSRO = document.getElementById('btnSaveSRO');

    const savedBase = localStorage.getItem('sroBaseUrl'); if (savedBase) sroBaseUrlInput.value = savedBase;
    btnSaveSRO.addEventListener('click', () => { localStorage.setItem('sroBaseUrl', sroBaseUrlInput.value.trim()); statusEl.textContent = 'Base SRO salva.'; });

    function gerarLinks(codes) {
      sroList.innerHTML = '';
      const base = sroBaseUrlInput.value.trim();
      const frag = document.createDocumentFragment();
      codes.forEach(code => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = base + encodeURIComponent(code);
        a.textContent = code;
        a.target = '_blank';
        a.rel = 'noopener';
        li.appendChild(a); frag.appendChild(li);
      });
      sroList.appendChild(frag);
      btnOpenAll.disabled = codes.length === 0;
    }
    btnGenLinks.addEventListener('click', () => {
      const lines = sroCodesInput.value
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(Boolean);
      const unique = [...new Set(lines)];
      gerarLinks(unique);
    });
    btnOpenAll.addEventListener('click', async () => {
      const links = Array.from(sroList.querySelectorAll('a')); if (!links.length) return;
      const step = 900; for (let i = 0; i < links.length; i++) { window.open(links[i].href, '_blank'); await new Promise(r => setTimeout(r, step)); }
    });

    // ===== Rastreamento automático (intranet) – opcional =====
    (function(){
      const useExtracted = document.getElementById('useExtracted');
      const codesManual = document.getElementById('codesManual');
      const chkSedex2 = document.getElementById('chkSedex2');
      const ufPostagem2 = document.getElementById('ufPostagem2');

      const btnConsultarAuto = document.getElementById('btnConsultarAuto');
      const btnExportAutoCSV = document.getElementById('btnExportAutoCSV');
      const btnExportAutoXLSX = document.getElementById('btnExportAutoXLSX');
      const autoStatus = document.getElementById('autoStatus');
      const autoTable = document.getElementById('autoTable');

      let lastAuto = [];
      const enableAutoExports = on => { btnExportAutoCSV.disabled = btnExportAutoXLSX.disabled = !on; };
      const normalize = s => String(s||'').trim();
      const upper = s => normalize(s).toUpperCase();

      function getCodes(){
        if (useExtracted.checked && collected.length) return [...new Set(collected)];
        const lines = (codesManual.value || '')
          .split(/\r?\n/)
          .map(s => s.trim())
          .filter(Boolean);
        return [...new Set(lines)];
      }
      function mapItem(r){
        const codigo = r.codigo || r.objeto || r.numeroObjeto || r.cod || '';
        const servico = r.servico || r.tipo || r.modalidade || '';
        const uf_postagem = r.uf_postagem || r.ufPostagem || r.origemUF || '';
        const unidade_destino = r.unidade_destino || r.destino || r.destino?.nome || r.emTransitoPara || '';
        const prazo_maximo = r.prazo_maximo || r.prazoMaximo || r.prazo || '';
        return { codigo, servico, uf_postagem, unidade_destino, prazo_maximo };
      }
      function filtrar(rows){
        const wantUF = upper(ufPostagem2.value);
        return rows.filter(x => {
          const isSedex = !chkSedex2.checked ? true : upper(x.servico).includes('SEDEX');
          const ufOK = !wantUF ? true : upper(x.uf_postagem) === wantUF;
          return isSedex && ufOK;
        });
      }
      function render(rows){
        autoTable.innerHTML = rows.map(r => `
          <tr class="border-t">
            <td class="p-2 font-mono">${XLSX.utils.escape_html(r.codigo||'')}</td>
            <td class="p-2">${XLSX.utils.escape_html(r.prazo_maximo||'')}</td>
            <td class="p-2">${XLSX.utils.escape_html(r.unidade_destino||'')}</td>
          </tr>`).join('');
        enableAutoExports(rows.length>0);
      }
      btnConsultarAuto.addEventListener('click', async () => {
        const objetos = getCodes();
        if (!objetos.length) { autoStatus.textContent = 'Nenhum código disponível.'; return; }
        autoStatus.textContent = 'Consultando…'; enableAutoExports(false); autoTable.innerHTML=''; lastAuto = [];
        try {
          const resp = await fetch('/api/rastrear', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ objetos }) });
          if (!resp.ok) throw new Error('HTTP '+resp.status);
          const data = await resp.json();
          const mapped = (Array.isArray(data) ? data : data.items || data.result || []).map(mapItem);
          lastAuto = filtrar(mapped);
          render(lastAuto);
          autoStatus.textContent = `OK — ${lastAuto.length} item(ns).`;
        } catch { autoStatus.textContent = 'Erro ao consultar. Verifique o proxy interno (/api/rastrear).'; }
      });
      btnExportAutoCSV.addEventListener('click', () => { const ws = XLSX.utils.json_to_sheet(lastAuto); const csv = XLSX.utils.sheet_to_csv(ws); download('relatorio_auto.csv', csv, 'text/csv;charset=utf-8'); });
      btnExportAutoXLSX.addEventListener('click', () => { const ws = XLSX.utils.json_to_sheet(lastAuto); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'relatorio'); const out = XLSX.write(wb, { bookType:'xlsx', type:'array' }); const blob = new Blob([out], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='relatorio_auto.xlsx'; a.click(); URL.revokeObjectURL(url); });
    })();

    // ===== Rastreamento por CSV (sem TI) + e-mail =====
    (function(){
      const csvFile = document.getElementById('csvFile');
      const csvPaste = document.getElementById('csvPaste');
      const mCodigo = document.getElementById('mCodigo');
      const mServico = document.getElementById('mServico');
      const mUF = document.getElementById('mUF');
      const mPrazo = document.getElementById('mPrazo');
      const mTransito = document.getElementById('mTransito');

      const csvOnlySedex = document.getElementById('csvOnlySedex');
      const csvUF = document.getElementById('csvUF');

      const btnCsvProcess = document.getElementById('btnCsvProcess');
      const btnCsvExport = document.getElementById('btnCsvExport');
      const btnCsvExportX = document.getElementById('btnCsvExportX');
      const btnEmail = document.getElementById('btnEmail');
      const btnCopyEmail = document.getElementById('btnCopyEmail');
      const btnCopySubject = document.getElementById('btnCopySubject');

      const csvTable = document.getElementById('csvTable');
      const emailPreviewWrap = document.getElementById('emailPreviewWrap');
      const emailPreview = document.getElementById('emailPreview');

      let csvReport = [];
      const enableCsvExports = on => { btnCsvExport.disabled = btnCsvExportX.disabled = btnEmail.disabled = btnCopyEmail.disabled = btnCopySubject.disabled = !on; };
      const normalizeHeader = h => String(h||'').trim().toLowerCase().replace(/\s+/g,'_');

      function rowsFromCSVText(text){
        const wb = XLSX.read(text, { type: 'string' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        return XLSX.utils.sheet_to_json(ws, { defval: '' });
      }
      async function rowsFromFile(file){
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        return XLSX.utils.sheet_to_json(ws, { defval: '' });
      }

      function applyMap(rows){
        const map = {
          codigo: normalizeHeader(mCodigo.value),
          servico: normalizeHeader(mServico.value),
          uf_postagem: normalizeHeader(mUF.value),
          prazo_maximo: normalizeHeader(mPrazo.value),
          em_transito_para: normalizeHeader(mTransito.value)
        };
        return rows.map(r => {
          const nr = {}; Object.keys(r).forEach(k => nr[normalizeHeader(k)] = r[k]);
          return {
            codigo: nr[map.codigo] || '',
            servico: nr[map.servico] || '',
            uf_postagem: nr[map.uf_postagem] || '',
            prazo_maximo: nr[map.prazo_maximo] || '',
            em_transito_para: nr[map.em_transito_para] || ''
          };
        });
      }

      function filterRows(rows){
        const wantUF = String(csvUF.value||'').toUpperCase();
        return rows.filter(r => {
          const isSedex = !csvOnlySedex.checked ? true : String(r.servico).toUpperCase().includes('SEDEX');
          const ufOK = !wantUF ? true : String(r.uf_postagem).toUpperCase() === wantUF;
          return isSedex && ufOK;
        });
      }

      function render(rows){
        csvTable.innerHTML = rows.map(r => `
          <tr class="border-t">
            <td class="p-2 font-mono">${XLSX.utils.escape_html(r.codigo||'')}</td>
            <td class="p-2">${XLSX.utils.escape_html(r.prazo_maximo||'')}</td>
            <td class="p-2">${XLSX.utils.escape_html(r.em_transito_para||'')}</td>
          </tr>`).join('');
        enableCsvExports(rows.length>0);
      }

      function exportRelXLSX(rows){
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'relatorio');
        const out = XLSX.write(wb, { bookType:'xlsx', type:'array' });
        const blob = new Blob([out], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `SEDEX ESTADUAL REATE-02 ${todayISO()}.xlsx`; a.click();
        URL.revokeObjectURL(url);
      }
      function exportRelCSV(rows){
        const ws = XLSX.utils.json_to_sheet(rows);
        const csv = XLSX.utils.sheet_to_csv(ws);
        download(`SEDEX ESTADUAL REATE-02 ${todayISO()}.csv`, csv, 'text/csv;charset=utf-8');
      }

      function makeEmailHTML(rows){
        const data = todayBR();
        const header = `<p>Prezados Gestores, bom dia!</p>
<p>Encaminhamos, para acompanhamento, a relação dos objetos <strong>SEDEX Estaduais</strong> com <strong>prazo de entrega para hoje, ${data}</strong>.</p>`;
        const tableHead = `<table border="1" cellpadding="6" cellspacing="0" style="border-collapse:collapse;font-family:Arial,Helvetica,sans-serif;font-size:12px;">
  <thead style="background:#e2e8f0;">
    <tr>
      <th align="left">Objeto</th>
      <th align="left">Data Máxima Entrega</th>
      <th align="left">Em trânsito para</th>
    </tr>
  </thead><tbody>`;
        const rowsHtml = rows.map(r => `<tr>
  <td>${XLSX.utils.escape_html(r.codigo||'')}</td>
  <td>${XLSX.utils.escape_html(r.prazo_maximo||'')}</td>
  <td>${XLSX.utils.escape_html(r.em_transito_para||'')}</td>
</tr>`).join('');
        const tableEnd = `</tbody></table>`;
        const footer = `<p>Solicitamos <strong>priorizar a entrega</strong>.</p>`;
        return header + tableHead + rowsHtml + tableEnd + footer;
      }

      function copyHTML(html){
        if (navigator.clipboard && window.ClipboardItem) {
          const data = new ClipboardItem({
            'text/html': new Blob([html], { type: 'text/html' }),
            'text/plain': new Blob([html.replace(/<[^>]+>/g,'')], { type: 'text/plain' })
          });
          return navigator.clipboard.write([data]);
        } else {
          const tmp = document.createElement('div');
          tmp.innerHTML = html; tmp.style.position='fixed'; tmp.style.left='-9999px';
          document.body.appendChild(tmp);
          const range = document.createRange(); range.selectNodeContents(tmp);
          const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
          const ok = document.execCommand('copy');
          sel.removeAllRanges(); document.body.removeChild(tmp);
          return ok ? Promise.resolve() : Promise.reject();
        }
      }

      // Processar CSV/XLSX colado ou enviado
      btnCsvProcess.addEventListener('click', async () => {
        let rows = [];
        try {
          if (csvFile.files && csvFile.files[0]) rows = await rowsFromFile(csvFile.files[0]);
          else if (csvPaste.value.trim()) rows = rowsFromCSVText(csvPaste.value);
          else { alert('Selecione um arquivo ou cole o conteúdo CSV.'); return; }
        } catch { alert('Não foi possível ler o arquivo/conteúdo.'); return; }

        rows = rows.map(r => { const nr={}; Object.keys(r).forEach(k=>nr[normalizeHeader(k)]=r[k]); return nr; });
        const mapped = applyMap(rows);
        const filtered = filterRows(mapped);
        csvReport = filtered.map(r => ({ codigo: r.codigo, prazo_maximo: r.prazo_maximo, em_transito_para: r.em_transito_para }));
        render(csvReport);
        emailPreviewWrap.classList.add('hidden');
      });

      btnCsvExportX.addEventListener('click', () => exportRelXLSX(csvReport));
      btnCsvExport.addEventListener('click',  () => exportRelCSV(csvReport));

      btnEmail.addEventListener('click', () => {
        const html = makeEmailHTML(csvReport);
        emailPreview.innerHTML = html;
        emailPreviewWrap.classList.remove('hidden');
      });
      btnCopyEmail.addEventListener('click', async () => {
        try { await copyHTML(emailPreview.innerHTML); alert('E-mail copiado (HTML). Cole no corpo do seu e-mail.'); }
        catch { alert('Não foi possível copiar como HTML. Selecione e copie manualmente a prévia.'); }
      });
      btnCopySubject.addEventListener('click', async () => {
        const subject = `SEDEX ESTADUAL – PRAZO ${todayBR()} (REATE-02)`;
        try { await navigator.clipboard.writeText(subject); alert('Assunto copiado.'); }
        catch { alert('Não foi possível copiar o assunto.'); }
      });
    })();
  </script>
</body>
</html>
